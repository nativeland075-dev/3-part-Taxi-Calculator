<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card 3: Breakdown</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0891b2; --light-gray: #f8fafc; --medium-gray: #e2e8f0; --dark-gray: #374151; --text-color: #1e293b; --subtle-text: #64748b; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { font-family: 'Inter', sans-serif; background-color: transparent; padding: 16px; display: flex; justify-content: center; align-items: center; }
        .calculator-card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); border: 1px solid var(--medium-gray); padding: 32px; width: 100%; max-width: 400px; display: flex; flex-direction: column; }
        .card-title { color: var(--text-color); font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 32px; }
        .breakdown-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--light-gray); }
        .breakdown-label { color: var(--subtle-text); font-size: 14px; }
        .breakdown-value { color: var(--text-color); font-size: 14px; font-weight: 500; }
        .breakdown-item.total-row { border-bottom: none; border-top: 2px solid var(--medium-gray); margin-top: 16px; padding-top: 16px; font-weight: 600; }
        .breakdown-item.total-row .breakdown-label { color: var(--text-color); font-weight: 600; }
        .total-fare { background: var(--primary-color); color: white; border-radius: 12px; padding: 16px 20px; text-align: center; }
        .total-label { font-size: 14px; font-weight: 500; opacity: 0.9; }
        .total-amount { font-size: 28px; font-weight: 700; }
        footer { text-align: center; margin-top: 16px; }
        .disclaimer { font-size: 12px; color: var(--subtle-text); font-style: italic; }
        .src-link { margin-top: 8px; }
        .src-link a { color: var(--primary-color); font-size: 12px; text-decoration: none; font-style: italic; }
        .actions-container { display: flex; justify-content: center; margin-top: 24px; border-top: 1px solid var(--light-gray); padding-top: 24px; }
        .action-btn { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 10px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); color: var(--dark-gray); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .action-btn:hover { background-color: var(--medium-gray); border-color: #cbd5e1; }
        .action-btn svg { width: 16px; height: 16px; stroke: currentColor; }

        #receipt-template {
            display: none;
        }

        /* --- CSS FOR PRINTING --- */
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-template, #receipt-template * {
                visibility: visible;
            }
            #receipt-template {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-family: sans-serif;
                color: #000;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-card">
        <h2 class="card-title">Fare Breakdown</h2>
        <div class="breakdown-item"><span class="breakdown-label">Base Fare</span><span class="breakdown-value" id="base-fare"></span></div>
        <div class="breakdown-item"><span class="breakdown-label">Distance (<span id="distance-display">0</span> km)</span><span class="breakdown-value" id="distance-subtotal"></span></div>
        <div class="breakdown-item"><span class="breakdown-label">Waiting Time (<span id="waiting-display">0</span> min)</span><span class="breakdown-value" id="waiting-subtotal"></span></div>
        <div class="breakdown-item"><span class="breakdown-label">Surcharges</span><span class="breakdown-value" id="surcharges-subtotal"></span></div>
        <div class="breakdown-item total-row"><span class="breakdown-label">Total Estimate</span><span class="breakdown-value" id="breakdown-total"></span></div>
        <div class="total-fare">
            <div class="total-label">Total Estimate</div>
            <div class="total-amount" id="total-amount" aria-live="polite"></div>
        </div>
        <footer>
            <p class="disclaimer">The actual fare will be determined by the meter at the end of the trip.</p>
            <p class="src-link"><a href="https://drive.google.com/file/d/16ln8X26blU9I3ItLeMwmFRVgeQnk0GqC/view?usp=sharing" target="_blank">Official Rate Source</a></p>
        </footer>
        <div class="actions-container">
            <button id="print-btn" class="action-btn" title="Print or Save as PDF">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 3.189m0 10.64l.72-3.623M17.28 13.829c.24.03.48.062.72.096m-.72-.096a42.415 42.415 0 00-10.56 0m10.56 0L18 3.189m0 10.64l-.72-3.623m0 0a2.25 2.25 0 00-2.14-2.14H8.86a2.25 2.25 0 00-2.14 2.14m7.56 0a2.25 2.25 0 012.14 2.14H6.72a2.25 2.25 0 012.14-2.14m7.56 0a2.25 2.25 0 01-2.14 2.14H8.86a2.25 2.25 0 01-2.14-2.14" /></svg>
                Print / Save PDF
            </button>
        </div>
    </div>
    
    <div id="receipt-template">
        <h2>Taxi Fare Estimate</h2>
        <p>Generated on: <span id="receipt-date"></span></p>
        <hr>
        <h4>Fare Breakdown</h4>
        <p>Base Fare: <span id="receipt-base-fare"></span></p>
        <p>Distance: <span id="receipt-distance-cost"></span></p>
        <p>Waiting Time: <span id="receipt-waiting-cost"></span></p>
        <p>Surcharges: <span id="receipt-surcharges"></span></p>
        <hr>
        <h3>TOTAL ESTIMATE: <span id="receipt-total"></span></h3>
        <hr>
        <p><em>This is an estimate only. The actual fare will be determined by the official taxi meter.</em></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'taxiFareData';
            const displays = {
                baseFare: document.getElementById('base-fare'),
                distanceDisplay: document.getElementById('distance-display'),
                distanceSubtotal: document.getElementById('distance-subtotal'),
                waitingDisplay: document.getElementById('waiting-display'),
                waitingSubtotal: document.getElementById('waiting-subtotal'),
                surchargesSubtotal: document.getElementById('surcharges-subtotal'),
                breakdownTotal: document.getElementById('breakdown-total'),
                totalAmount: document.getElementById('total-amount'),
            };
            const receiptDisplays = {
                date: document.getElementById('receipt-date'),
                baseFare: document.getElementById('receipt-base-fare'),
                distanceCost: document.getElementById('receipt-distance-cost'),
                waitingCost: document.getElementById('receipt-waiting-cost'),
                surcharges: document.getElementById('receipt-surcharges'),
                total: document.getElementById('receipt-total'),
            };

            const printBtn = document.getElementById('print-btn');
            const RATES = { baseFare: 1000, dayRatePerKm: 160, nightRatePerKm: 260, waitingRatePerMinute: 2500 / 60, surcharges: { luggage: 100, largeItem: 500, mountainClimb: 500, fifthPassenger: 500 } };
            const currencyFormatter = new Intl.NumberFormat('fr-PF', { style: 'currency', currency: 'XPF', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            
            const getStoredData = () => {
                const storedData = localStorage.getItem(STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : { distance: 0, tripTime: '12:00', waitingTime: 0, passengers: 1, luggage: 0, largeItems: 0, mountainClimb: false };
            };
            
            const isNightRate = (timeString) => {
                if (!timeString) return false;
                const hour = parseInt(timeString.split(':')[0], 10);
                return hour >= 20 || hour < 6;
            };

            const getCalculation = (data) => {
                const baseFare = RATES.baseFare;
                const ratePerKm = isNightRate(data.tripTime) ? RATES.nightRatePerKm : RATES.dayRatePerKm;
                const distanceSubtotal = (parseFloat(data.distance) || 0) * ratePerKm;
                const waitingSubtotal = data.waitingTime * RATES.waitingRatePerMinute;
                let surcharges = 0;
                surcharges += data.luggage * RATES.surcharges.luggage;
                surcharges += data.largeItems * RATES.surcharges.largeItem;
                if (data.mountainClimb) surcharges += RATES.surcharges.mountainClimb;
                if (data.passengers === 5) surcharges += RATES.surcharges.fifthPassenger;
                const totalFare = baseFare + distanceSubtotal + waitingSubtotal + surcharges;
                return { baseFare, distanceSubtotal, waitingSubtotal, surcharges, totalFare };
            };

            const render = () => {
                const data = getStoredData();
                const { baseFare, distanceSubtotal, waitingSubtotal, surcharges, totalFare } = getCalculation(data);
                displays.baseFare.textContent = currencyFormatter.format(baseFare);
                displays.distanceDisplay.textContent = (parseFloat(data.distance) || 0).toFixed(1);
                displays.distanceSubtotal.textContent = currencyFormatter.format(distanceSubtotal);
                displays.waitingDisplay.textContent = data.waitingTime;
                displays.waitingSubtotal.textContent = currencyFormatter.format(waitingSubtotal);
                displays.surchargesSubtotal.textContent = currencyFormatter.format(surcharges);
                displays.breakdownTotal.textContent = currencyFormatter.format(totalFare);
                displays.totalAmount.textContent = currencyFormatter.format(totalFare);
            };
            
            printBtn.addEventListener('click', () => {
                const data = getStoredData();
                const { baseFare, distanceSubtotal, waitingSubtotal, surcharges, totalFare } = getCalculation(data);
                
                // 1. Populate the hidden receipt template
                receiptDisplays.date.textContent = new Date().toLocaleString('en-US');
                receiptDisplays.baseFare.textContent = currencyFormatter.format(baseFare);
                receiptDisplays.distanceCost.textContent = currencyFormatter.format(distanceSubtotal);
                receiptDisplays.waitingCost.textContent = currencyFormatter.format(waitingSubtotal);
                receiptDisplays.surcharges.textContent = currencyFormatter.format(surcharges);
                receiptDisplays.total.textContent = currencyFormatter.format(totalFare);
                
                // 2. Call the browser's native print function
                window.print();
            });

            window.addEventListener('storage', render);
            window.addEventListener('storageUpdated', render);
            render();
        });
    </script>
</body>

</html>
